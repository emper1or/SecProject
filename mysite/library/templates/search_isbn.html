{% extends 'index.html' %}

{% block content %}
<form method="POST" action="{% url 'book_search_isbn' %}" class="search-form">
    {% csrf_token %}
    <input type="text" name="isbn" id="isbnInput" placeholder="–í–≤–µ–¥–∏—Ç–µ ISBN" required>
    <button type="submit">üîç </button>
</form>
<p class="or-separator">–∏–ª–∏</p>
<button id="startScanner">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö-–∫–æ–¥</button>
<div id="scanner-container" style="display: none; width: 100%; max-width: 500px; margin: 20px auto; position: relative;">
    <video id="scanner" width="100%" playsinline style="border: 2px solid #007ba8; border-radius: 8px; background: black;"></video>
    <div style=""></div>
    <button id="stopScanner" style="margin-top: 10px;">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
    <p id="scanStatus" style="color: #00A1DB; font-weight: bold;"></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const startBtn = document.getElementById('startScanner');
        const stopBtn = document.getElementById('stopScanner');
        const scannerContainer = document.getElementById('scanner-container');
        const scannerElement = document.getElementById('scanner');
        const isbnInput = document.getElementById('isbnInput');
        const scanStatus = document.getElementById('scanStatus');
        let stream = null;

        // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–∞–º–µ—Ä—ã
        function getCameraSettings() {
            return {
                width: { ideal: 1280 },
                height: { ideal: 720 },
                facingMode: isMobileDevice() ? { exact: "environment" } : "user",
                focusMode: "continuous"
            };
        }

        startBtn.addEventListener('click', async function() {
            try {
                scannerContainer.style.display = 'block';
                startBtn.style.display = 'none';
                scanStatus.textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã...';

                // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                stream = await navigator.mediaDevices.getUserMedia({
                    video: getCameraSettings(),
                    audio: false
                });

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Ç–æ–∫ –≤ –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–µ
                scannerElement.srcObject = stream;
                await scannerElement.play();
                scanStatus.textContent = '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥';

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Quagga —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: scannerElement,
                        constraints: getCameraSettings()
                    },
                    decoder: {
                        readers: isMobileDevice() ?
                            ["ean_reader", "ean_8_reader"] :  // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö - —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
                            ["ean_reader", "ean_8_reader", "code_128_reader", "upc_reader", "upc_e_reader"],
                    },
                    locate: true,
                    numOfWorkers: isMobileDevice() ? 2 : 4  // –ú–µ–Ω—å—à–µ –≤–æ—Ä–∫–µ—Ä–æ–≤ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                }, function(err) {
                    if (err) {
                        console.error(err);
                        scanStatus.textContent = '–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∫–∞–Ω–µ—Ä–∞';
                        stopScanner();
                        return;
                    }
                    Quagga.start();
                    scanStatus.textContent = '–ì–æ—Ç–æ–≤–æ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥';
                });

                Quagga.onDetected(function(result) {
                    if (!result.codeResult) return;

                    const code = result.codeResult.code;
                    isbnInput.value = code;
                    scanStatus.textContent = '–ù–∞–π–¥–µ–Ω —à—Ç—Ä–∏—Ö-–∫–æ–¥: ' + code;

                    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
                    scannerElement.style.border = '2px solid #ff5722';
                    setTimeout(() => {
                        scannerElement.style.border = '2px solid #00A1DB';
                    }, 1000);

                    // –í–∏–±—Ä–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
                    if (isMobileDevice() && navigator.vibrate) {
                        navigator.vibrate(200);
                    }
                });

            } catch (err) {
                console.error("–û—à–∏–±–∫–∞:", err);
                scanStatus.textContent = '–û—à–∏–±–∫–∞: ' + (err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ');
                stopScanner();
            }
        });

        function stopScanner() {
            if (Quagga && Quagga.initialized) {
                Quagga.stop();
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (scannerElement.srcObject) {
                scannerElement.srcObject = null;
            }
            scannerContainer.style.display = 'none';
            startBtn.style.display = 'block';
            startBtn.style.marginLeft = 'auto';  // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            startBtn.style.marginRight = 'auto';  // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        }

        stopBtn.addEventListener('click', stopScanner);
    });
</script>

<style>
    #startScanner, #stopScanner {
    padding: 12px 20px;
    background-color: #00A1DB;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    margin: 10px 0;
    transition: background-color 0.3s;
    display: block;
    margin-left: auto;
    margin-right: auto;
}

#startScanner:hover, #stopScanner:hover {
    background-color: #007ba8;
}

#scanner-container {
    background: #f9f9f9;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    text-align: center;  /* —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
}

#scanStatus {
    margin: 10px 0;
    min-height: 24px;
    text-align: center;
}

#scanner {
    background: #000;
    display: block;
    margin: 0 auto;
}
    @media (max-width: 600px) {
        #scanner-container {
            width: 95%;
            padding: 10px;
        }

        #startScanner, #stopScanner {
            padding: 10px 16px;
            font-size: 15px;
        }
    }
.search-form {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin: 30px auto;
    flex-wrap: wrap;
    width: 100%;
    max-width: 600px;
}

.search-form input[type="text"] {
    width: 100%;
    max-width: 300px;
    padding: 10px 15px;
    font-size: 16px;
    border: 2px solid #ccc;
    border-radius: 8px;
    transition: 0.3s ease;
}

.search-form input[type="text"]:focus {
    border-color: #00A1DB;
    outline: none;
    box-shadow: 0 0 6px rgba(76, 175, 80, 0.4);
}

.search-form button[type="submit"] {
    padding: 10px 20px;
    font-size: 16px;
    background-color: #00A1DB;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.2s;
}

.search-form button[type="submit"]:hover {
    background-color: #007ba8;
    transform: translateY(-2px);
}
    .or-separator {
    text-align: center;
    font-size: 18px;
    font-weight: 500;
    margin: 15px 0;
    color: #666;
}


</style>
{% endblock %}