{% extends 'index.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ topic.title }}</h1>
        <a href="{% url 'category_topics' topic.category.id %}" class="btn btn-outline-secondary">
            Назад к категории
        </a>
    </div>

    {% if topic.description %}
    <div class="mb-4">
        <p class="text-muted">{{ topic.description }}</p>
    </div>
    {% endif %}

    <!-- Контейнер для сообщений форума -->
    <div class="forum-messages mb-5" id="messages-container">
        {% for forum_message in forum_messages %}
            {% include 'forum/message.html' with message=forum_message %}
        {% empty %}
            <div class="alert alert-info">Пока нет сообщений в этой теме. Будьте первым!</div>
        {% endfor %}
    </div>

    <!-- Форма нового сообщения -->
    {% if user.is_authenticated %}
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Новое сообщение</h5>
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'add_message' topic.id %}" id="main-message-form">
                {% csrf_token %}
                <div class="mb-3">
                    <textarea name="content" class="form-control" rows="3" required
                              placeholder="Напишите ваше сообщение..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Отправить</button>
            </form>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <a href="{% url 'login' %}?next={% url 'topic_messages' topic.id %}">Войдите</a>, чтобы оставлять сообщения
    </div>
    {% endif %}
</div>

<script>
// Функция для получения CSRF токена
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Сохранение голосов в localStorage
function saveVoteToLocalStorage(messageId, voteType) {
    const votes = JSON.parse(localStorage.getItem('forumVotes') || '{}');
    if (voteType === null) {
        delete votes[messageId];
    } else {
        votes[messageId] = voteType;
    }
    localStorage.setItem('forumVotes', JSON.stringify(votes));
}

// Восстановление голосов при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    if (!localStorage.getItem('forumVotes')) return;

    const votes = JSON.parse(localStorage.getItem('forumVotes'));
    Object.keys(votes).forEach(messageId => {
        const form = document.querySelector(`.vote-form[data-message-id="${messageId}"]`);
        if (form) {
            const voteType = votes[messageId];
            const likeBtn = form.querySelector('.like-btn');
            const dislikeBtn = form.querySelector('.dislike-btn');

            likeBtn.classList.toggle('btn-success', voteType === 'like');
            likeBtn.classList.toggle('btn-outline-success', voteType !== 'like');

            dislikeBtn.classList.toggle('btn-danger', voteType === 'dislike');
            dislikeBtn.classList.toggle('btn-outline-danger', voteType !== 'dislike');
        }
    });
});

// Обработчик лайков/дизлайков
document.addEventListener('click', async function(e) {
    if (e.target.closest('.like-btn, .dislike-btn')) {
        const btn = e.target.closest('.like-btn, .dislike-btn');
        const form = btn.closest('.vote-form');
        const messageId = form.dataset.messageId;
        const voteType = btn.classList.contains('like-btn') ? 'like' : 'dislike';
        const csrfToken = getCookie('csrftoken');

        try {
            const response = await fetch(`/forum/message/${messageId}/vote/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    vote_type: voteType
                })
            });

            if (!response.ok) throw new Error('Ошибка сети');

            const data = await response.json();

            if (data.success) {
                // Обновляем счетчики
                form.querySelector('.like-count').textContent = data.likes;
                form.querySelector('.dislike-count').textContent = data.dislikes;

                // Обновляем стили кнопок
                const likeBtn = form.querySelector('.like-btn');
                const dislikeBtn = form.querySelector('.dislike-btn');

                likeBtn.classList.toggle('btn-success', data.user_vote === 'like');
                likeBtn.classList.toggle('btn-outline-success', data.user_vote !== 'like');

                dislikeBtn.classList.toggle('btn-danger', data.user_vote === 'dislike');
                dislikeBtn.classList.toggle('btn-outline-danger', data.user_vote !== 'dislike');

                // Сохраняем в localStorage
                saveVoteToLocalStorage(messageId, data.user_vote);
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Произошла ошибка при голосовании');
        }
    }
});

// Обработчик кнопок "Ответить"
document.addEventListener('click', function(e) {
    // Показать/скрыть форму ответа
    if (e.target.closest('.reply-btn')) {
        const btn = e.target.closest('.reply-btn');
        const messageId = btn.dataset.messageId;
        const replyForm = document.getElementById(`reply-form-${messageId}`);

        // Скрываем все другие формы ответов
        document.querySelectorAll('.reply-form').forEach(form => {
            if (form.id !== `reply-form-${messageId}`) form.style.display = 'none';
        });

        // Показываем/скрываем текущую форму
        replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';

        // Плавная прокрутка к форме
        if (replyForm.style.display === 'block') {
            replyForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }

    // Отмена ответа
    if (e.target.closest('.cancel-reply')) {
        e.target.closest('.reply-form').style.display = 'none';
    }
});

// Обработчик отправки всех форм
document.addEventListener('submit', async function(e) {
    e.preventDefault();

    // Обработка основной формы нового сообщения
    if (e.target.id === 'main-message-form') {
        const form = e.target;
        const formData = new FormData(form);
        const csrfToken = getCookie('csrftoken');

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });

            if (response.ok) {
                window.location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Ошибка при отправке сообщения');
        }
        return;
    }

    // Обработка формы ответа
    if (e.target.closest('.ajax-reply-form')) {
        const form = e.target.closest('.ajax-reply-form');
        const formData = new FormData(form);
        const parentId = formData.get('parent_id');
        const csrfToken = getCookie('csrftoken');

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                }
            });

            const data = await response.json();

            if (data.success) {
                const parentElement = document.getElementById(`message-${parentId}`);
                let repliesContainer = parentElement.nextElementSibling;

                // Создаем контейнер для ответов если его нет
                if (!repliesContainer || !repliesContainer.classList.contains('replies')) {
                    repliesContainer = document.createElement('div');
                    repliesContainer.className = 'replies ms-4 mt-2';
                    parentElement.parentNode.insertBefore(repliesContainer, parentElement.nextSibling);
                }

                // Добавляем ответ с анимацией
                repliesContainer.insertAdjacentHTML('beforeend', data.html);
                const newMessage = repliesContainer.lastElementChild;
                newMessage.style.opacity = 0;

                setTimeout(() => {
                    newMessage.style.opacity = 1;
                }, 10);

                // Сбрасываем и скрываем форму
                form.reset();
                form.style.display = 'none';

                // Прокручиваем к новому ответу
                newMessage.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest'
                });
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Ошибка при отправке ответа');
        }
    }
});
</script>
{% endblock %}